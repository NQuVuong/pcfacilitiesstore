{% extends 'admin.html.twig' %}

{% block title %}Revenue dashboard{% endblock %}

{% block body %}
<div class="p-6 space-y-6">

  <h1 class="text-2xl font-bold mb-4">Revenue overview</h1>

  {# ==== Hàng card 1: doanh thu hôm nay / tuần / tháng ==== #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">Today revenue</p>
        <p class="text-2xl font-semibold">
          {{ todayRevenue|number_format(0, '.', ',') }} ₫
        </p>
        <p class="text-xs text-base-content/60">
          {{ todayOrders }} orders
        </p>
      </div>
    </div>

    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">This week</p>
        <p class="text-2xl font-semibold">
          {{ weekRevenue|number_format(0, '.', ',') }} ₫
        </p>
        <p class="text-xs text-base-content/60">
          {{ weekOrders }} orders
        </p>
      </div>
    </div>

    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">This month</p>
        <p class="text-2xl font-semibold">
          {{ monthRevenue|number_format(0, '.', ',') }} ₫
        </p>
        <p class="text-xs text-base-content/60">
          {{ monthOrders }} orders
        </p>
      </div>
    </div>
  </div>

  {# ==== Hàng card 2: cost & profit tháng hiện tại ==== #}
  <div class="grid gap-4 md:grid-cols-2">
    <div class="stats shadow bg-base-100">
      <div class="stat">
        <div class="stat-title">Cost this month</div>
        <div class="stat-value text-error">
          {{ monthCost|number_format(0, '.', ',') }} ₫
        </div>
      </div>
    </div>

    <div class="stats shadow bg-base-100">
      <div class="stat">
        <div class="stat-title">Profit this month</div>
        {% set mp = monthProfit %}
        <div class="stat-value {{ mp >= 0 ? 'text-success' : 'text-error' }}">
          {{ mp|number_format(0, '.', ',') }} ₫
        </div>
      </div>
    </div>
  </div>

  {# ==== Bảng & chart ==== #}
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    {# Top products by quantity #}
    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <h2 class="card-title text-sm mb-2">Top products by quantity</h2>
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th class="text-right">Qty</th>
                <th class="text-right">Revenue</th>
              </tr>
            </thead>
            <tbody>
            {% for row in topProducts %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ row.productName }}</td>
                <td class="text-right">{{ row.qty }}</td>
                <td class="text-right">
                  {{ row.revenue|number_format(0, '.', ',') }} ₫
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4" class="text-center text-sm text-base-content/60">No data</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {# Chart: Revenue / Cost / Profit 6 tháng gần nhất #}
    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <h2 class="card-title text-sm mb-3">
          Revenue / Cost / Profit (last 6 months)
        </h2>
        <div class="w-full h-64">
          <canvas id="profitChart" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>

  </div>

  {# ========== Chart.js ========== #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      const labels   = {{ profitLabels|json_encode|raw }};
      const revenues = {{ profitRevenues|json_encode|raw }};
      const costs    = {{ profitCosts|json_encode|raw }};
      const profits  = {{ profitProfits|json_encode|raw }};

      const ctx = document.getElementById('profitChart');
      if (!ctx) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Revenue (₫)',
              data: revenues,
            },
            {
              label: 'Cost (₫)',
              data: costs,
            },
            {
              label: 'Profit (₫)',
              data: profits,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              ticks: {
                callback: function (value) {
                  return value.toLocaleString('vi-VN');
                }
              }
            }
          }
        }
      });
    })();
  </script>

</div>
{% endblock %}
