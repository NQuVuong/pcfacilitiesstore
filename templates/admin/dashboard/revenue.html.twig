{# templates/admin/revenue/index.html.twig #}
{% extends 'admin.html.twig' %}

{% block title %}Revenue dashboard{% endblock %}

{% block body %}
<div class="p-6 space-y-6">
  <h1 class="text-2xl font-bold mb-4">Revenue overview</h1>

  {# Cards doanh thu #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">Today revenue</p>
        <p class="text-2xl font-semibold">{{ todayRevenue|number_format(0, '.', ',') }} ₫</p>
        <p class="text-xs text-base-content/60">{{ todayOrders }} orders</p>
      </div>
    </div>

    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">This week</p>
        <p class="text-2xl font-semibold">{{ weekRevenue|number_format(0, '.', ',') }} ₫</p>
        <p class="text-xs text-base-content/60">{{ weekOrders }} orders</p>
      </div>
    </div>

    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <p class="text-sm text-base-content/60">This month</p>
        <p class="text-2xl font-semibold">{{ monthRevenue|number_format(0, '.', ',') }} ₫</p>
        <p class="text-xs text-base-content/60">{{ monthOrders }} orders</p>
      </div>
    </div>
  </div>

  {# Lời / lỗ tổng #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-base-100 shadow border col-span-1 md:col-span-3">
      <div class="card-body flex flex-wrap gap-6 items-center">
        <div>
          <p class="text-sm text-base-content/60">Total revenue this month</p>
          <p class="text-xl font-semibold">{{ monthRevenue|number_format(0,'.',',') }} ₫</p>
        </div>
        <div>
          <p class="text-sm text-base-content/60">Total cost this month</p>
          <p class="text-xl font-semibold text-error">{{ monthCost|number_format(0,'.',',') }} ₫</p>
        </div>
        <div>
          <p class="text-sm text-base-content/60">Profit this month</p>
          <p class="text-xl font-semibold {{ monthProfit >= 0 ? 'text-green-600' : 'text-red-600' }}">
            {{ monthProfit|number_format(0,'.',',') }} ₫
          </p>
        </div>
      </div>
    </div>
  </div>

  {# Top sản phẩm bán nhiều + top viewed #}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <h2 class="card-title text-sm mb-2">Top products by quantity</h2>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Revenue</th>
            </tr>
          </thead>
          <tbody>
          {% for row in topProducts %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ row.productName }}</td>
              <td class="text-right">{{ row.qty }}</td>
              <td class="text-right">
                {{ row.revenue|number_format(0,'.',',') }} ₫
              </td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-center text-sm text-base-content/60">No data</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card bg-base-100 shadow border">
      <div class="card-body">
        <h2 class="card-title text-sm mb-2">Most viewed products</h2>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th class="text-right">Views</th>
            </tr>
          </thead>
          <tbody>
          {% for p in topViewed %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ p.name }}</td>
              <td class="text-right">{{ p.views }}</td>
            </tr>
          {% else %}
            <tr><td colspan="3" class="text-center text-sm text-base-content/60">No data</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Chart Revenue / Cost / Profit 6 tháng #}
  <div class="bg-base-100 rounded-xl shadow p-4">
    <h2 class="font-semibold mb-3">Revenue / Cost / Profit (last 6 months)</h2>
    <div class="relative h-72">
      <canvas id="profitChart" class="w-full h-full"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function () {
  const labels   = {{ profitLabels|json_encode|raw }};
  const revenues = {{ profitRevenues|json_encode|raw }};
  const costs    = {{ profitCosts|json_encode|raw }};
  const profits  = {{ profitProfits|json_encode|raw }};

  const ctx = document.getElementById('profitChart');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Revenue (₫)',
          data: revenues,
        },
        {
          label: 'Cost (₫)',
          data: costs,
        },
        {
          label: 'Profit (₫)',
          data: profits,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
            callback: value => value.toLocaleString('vi-VN')
          }
        }
      }
    }
  });
})();
</script>
{% endblock %}
