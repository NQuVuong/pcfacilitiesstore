{% set latest   = p.prices|first %}
{% set hasPrice = latest is not null and latest.exportPrice is not null %}
{% set maxSpecs = specs_count|default(3) %}
{% set specs    = p.specs|default([]) %}

{% set shown = [] %}
{% for it in specs %}
  {% set k = it.key|default('') %}
  {% set v = it.value|default('') %}
  {% if (k is not empty or v is not empty) and shown|length < maxSpecs %}
    {% set shown = shown|merge([{'k': k, 'v': v}]) %}
  {% endif %}
{% endfor %}

<div class="bg-white rounded-xl border border-slate-200 card-smooth overflow-hidden">

  <a href="{{ path('product_detail', {'slug': p.slug}) }}" class="block aspect-[4/3] bg-slate-100">
    <img src="{{ asset('uploads/' ~ p.image) }}"
         alt="{{ p.name }}"
         class="w-full h-full object-contain"/>
  </a>

  <div class="p-4 space-y-3">

    <a class="line-clamp-2 font-medium hover:text-indigo-600"
       href="{{ path('product_detail', {'slug': p.slug}) }}">
      {{ p.name }}
    </a>

    {# ⭐ PRODUCT RATING #}
    {% if p.getReviewCount() > 0 %}
      <div class="flex items-center gap-1 text-amber-500 text-sm">
        <i class="fa-solid fa-star"></i>
        <span class="font-semibold">{{ p.getAverageRating() }}/5</span>
        <span class="text-slate-500">({{ p.getReviewCount() }} reviews)</span>
      </div>
    {% endif %}

    {% if shown|length > 0 %}
      <div class="grid gap-1">
        {% for s in shown %}
          <div class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-md border bg-slate-50">
            <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
            <span class="text-slate-500 whitespace-nowrap">{{ s.k ?: 'Spec' }}:</span>
            <span class="truncate font-medium">{{ s.v }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="flex items-center gap-3 pt-1">

      <span class="leading-none">
        {% if hasPrice %}
          <span class="text-primary font-extrabold text-[18px] sm:text-[20px] lg:text-[22px]">
            {{ latest.exportPrice|number_format(0, '.', ',') }} ₫
          </span>
        {% else %}
          <span class="text-slate-400 italic">No price</span>
        {% endif %}
      </span>

      {# STOCK STATUS — KEEP ENGLISH #}
      {% if p.quantity > 0 %}
        {% if p.quantity <= 3 %}
          <span class="chip bg-amber-50 text-amber-800">Low stock ({{ p.quantity }})</span>
        {% else %}
          <span class="chip chip-stock">In stock: {{ p.quantity }}</span>
        {% endif %}
      {% else %}
        <span class="chip chip-oos">Out of stock</span>
      {% endif %}
    </div>

  </div>
</div>
