{# templates/_components/product-card.html.twig #}
{# expects: p (Product) #}
<div class="bg-white rounded-xl border border-slate-200 card-smooth overflow-hidden">
  <a href="{{ path('product_detail', {'id': p.id}) }}" class="block aspect-[4/3] bg-slate-100">
    <img src="{{ asset('uploads/' ~ p.image) }}" alt="{{ p.name }}" class="w-full h-full object-cover"/>
  </a>

  <div class="p-4 space-y-3">
    <a class="line-clamp-2 font-medium hover:text-indigo-600" href="{{ path('product_detail', {'id': p.id}) }}">
      {{ p.name }}
    </a>

    {% set latest   = p.prices|first %}
    {% set hasPrice = latest is not null and latest.exportPrice is not null %}
    {% set canBuy   = hasPrice and p.quantity > 1 %}

    <div class="flex items-center gap-2">
      <span class="chip chip-price">
        {% if hasPrice %}
          {{ latest.exportPrice|number_format(0, '.', ',') }} ₫
        {% else %}
          Chưa đặt
        {% endif %}
      </span>

      {% if p.quantity > 0 %}
        {% if p.quantity <= 3 %}
          <span class="chip bg-amber-50 text-amber-800">Sắp hết ({{ p.quantity }})</span>
        {% else %}
          <span class="chip chip-stock">Now: {{ p.quantity }}</span>
        {% endif %}
      {% else %}
        <span class="chip chip-oos">Out of stock</span>
      {% endif %}
    </div>

    <div class="flex justify-end pt-1">
      {% if canBuy %}
        <form action="{{ path('app_cart_add', {id: p.id}) }}" method="post">
          <input type="hidden" name="_token" value="{{ csrf_token('add_to_cart_' ~ p.id) }}">
          <button class="btn btn-primary btn-sm" type="submit">
            <i data-lucide="shopping-bag" class="w-4 h-4 mr-1"></i> Add
          </button>
        </form>
      {% else %}
        <button class="btn btn-sm btn-disabled" disabled>
          {% if not hasPrice %}Not Priced
          {% elseif p.quantity <= 1 %}Reach the limit
          {% else %}Out of stock{% endif %}
        </button>
      {% endif %}
    </div>
  </div>
</div>
