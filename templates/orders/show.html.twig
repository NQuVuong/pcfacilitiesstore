{# templates/orders/show.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Order #{{ order.id }}{% endblock %}

{% block body %}
<div class="max-w-5xl mx-auto p-4 space-y-4">

  {# Flash messages #}
  {% for label, messages in app.flashes(['shop.success', 'shop.error', 'shop.info']) %}
    {% for m in messages %}
      {% set alert_class = 'alert-info' %}
      {% if label == 'shop.success' %}
        {% set alert_class = 'alert-success' %}
      {% elseif label == 'shop.error' %}
        {% set alert_class = 'alert-error' %}
      {% endif %}
      <div class="alert {{ alert_class }} mb-3">
        <span>{{ m|raw }}</span>
      </div>
    {% endfor %}
  {% endfor %}

  {# Thông tin order + status + step #}
  <div class="card bg-base-100 shadow">
    <div class="card-body space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div>
          <h1 class="text-xl font-semibold">Order #{{ order.id }}</h1>
          <p class="text-sm text-base-content/70">
            Placed on {{ order.createdAt|date('Y-m-d H:i') }}
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-base-content/70">Status</div>
          <span class="badge
            {% if order.status in ['PAID','PAID_CONFIRMED','DELIVERED','COMPLETED','REFUNDED'] %}badge-success
            {% elseif order.status in ['NEW','PREPARING','SHIPPING','PENDING'] %}badge-warning
            {% elseif order.status in ['REFUND_REQUESTED','REFUND_PROCESSING'] %}badge-info
            {% elseif order.status in ['CANCELED','REFUND_REJECTED'] %}badge-ghost
            {% elseif order.status in ['FAILED','REFUND_FAILED'] %}badge-error
            {% else %}badge-neutral{% endif %}">
            {{ order.status|replace({'_': ' '})|capitalize }}
          </span>
        </div>
      </div>

      <div class="text-sm text-base-content/80">
        <div>Total: <b>{{ order.total|number_format(0,'.',',') }} ₫</b></div>
        {% if order.paymentMethod %}
          <div>Payment: <b>{{ order.paymentMethod == 'MOMO' ? 'MoMo e-wallet' : 'Cash on delivery' }}</b></div>
        {% endif %}
      </div>

      {# Steps hiển thị tiến trình #}
      {% set step = 1 %}
      {% if order.status in ['PREPARING'] %}
        {% set step = 2 %}
      {% elseif order.status in ['SHIPPING'] %}
        {% set step = 3 %}
      {% elseif order.status in ['DELIVERED','PAID_CONFIRMED','COMPLETED','REFUND_REQUESTED','REFUNDED'] %}
        {% set step = 4 %}
      {% endif %}

      <div class="mt-2">
        <ul class="steps w-full text-xs sm:text-sm">
          <li class="step {{ step >= 1 ? 'step-primary' : '' }}">Placed</li>
          <li class="step {{ step >= 2 ? 'step-primary' : '' }}">Preparing</li>
          <li class="step {{ step >= 3 ? 'step-primary' : '' }}">On the way</li>
          <li class="step {{ step >= 4 ? 'step-primary' : '' }}">Delivered</li>
        </ul>
      </div>
    </div>
  </div>

  {# Items #}
  <div class="card bg-base-100 shadow overflow-x-auto">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr class="text-left text-sm text-gray-600">
          <th class="px-6 py-3">Product</th>
          <th class="px-6 py-3">Price</th>
          <th class="px-6 py-3">Qty</th>
          <th class="px-6 py-3">Subtotal</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for it in order.items %}
          <tr class="text-sm">
            <td class="px-6 py-4">
              {{ it.productName }}
            </td>
            <td class="px-6 py-4">{{ it.unitPrice|number_format(0,'.',',') }} ₫</td>
            <td class="px-6 py-4">{{ it.quantity }}</td>
            <td class="px-6 py-4 font-medium">{{ it.lineTotal|number_format(0,'.',',') }} ₫</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Các nút action của customer #}
  <div class="flex flex-wrap items-center gap-2">
    <a href="{{ path('app_orders_index') }}" class="btn btn-ghost">← Back to orders</a>

    {# CONFIRM RECEIVED (chỉ khi admin đã set DELIVERED) #}
    {% if order.status == 'DELIVERED' %}
      <button class="btn btn-primary mt-2"
              type="button"
              onclick="document.getElementById('confirm-delivered-modal').showModal()">
        I have received the order
      </button>

      <dialog id="confirm-delivered-modal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg mb-2">Confirm received</h3>
          <p>Confirm you have received this order?</p>
          <div class="modal-action">
            <form method="post"
                  action="{{ path('app_orders_confirm_delivered', {id: order.id}) }}">
              <input type="hidden" name="_token"
                     value="{{ csrf_token('confirm_delivered_' ~ order.id) }}">
              <button type="submit" class="btn btn-primary">OK</button>
            </form>
            <form method="dialog">
              <button class="btn">Cancel</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    {% endif %}

    {# REQUEST REFUND: chỉ khi COMPLETED + còn trong 5 phút + chưa vào flow refund #}
    {% if canRequestRefund %}
      <button class="btn btn-error btn-outline mt-2"
              type="button"
              onclick="document.getElementById('refund-modal').showModal()">
        Request return / refund
      </button>

      <dialog id="refund-modal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg mb-2">Request return / refund</h3>
          <p>Send return / refund request for order #{{ order.id }}?</p>
          <div class="modal-action">
            <form method="post"
                  action="{{ path('app_orders_request_refund', {id: order.id}) }}">
              <input type="hidden" name="_token"
                     value="{{ csrf_token('request_refund_' ~ order.id) }}">
              <button type="submit" class="btn btn-error">Send request</button>
            </form>
            <form method="dialog">
              <button class="btn">Cancel</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    {% endif %}

    {# Thông báo trạng thái refund #}
    {% if order.status == 'REFUND_REQUESTED' %}
      <div class="alert alert-info mt-4">
        Your refund request is being reviewed by admin.
      </div>
    {% elseif order.status == 'REFUND_PROCESSING' %}
      <div class="alert alert-warning mt-4">
        Refund is being processed.
      </div>
    {% elseif order.status == 'REFUNDED' %}
      <div class="alert alert-success mt-4">
        This order has been refunded.
      </div>
    {% elseif order.status == 'REFUND_REJECTED' %}
      <div class="alert alert-error mt-4">
        Refund request has been rejected.
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
