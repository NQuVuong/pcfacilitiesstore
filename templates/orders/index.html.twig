{# templates/orders/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}My orders{% endblock %}

{% block body %}
<div class="container mx-auto max-w-6xl p-4">
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h1 class="text-2xl font-semibold mb-4">My orders</h1>

      {# Flash messages #}
      {% for label, messages in app.flashes(['shop.success', 'shop.error', 'shop.info']) %}
        {% for m in messages %}
          {% set alert_class = 'alert-info' %}
          {% if label == 'shop.success' %}
            {% set alert_class = 'alert-success' %}
          {% elseif label == 'shop.error' %}
            {% set alert_class = 'alert-error' %}
          {% endif %}
          <div class="alert {{ alert_class }} mb-3">
            <span>{{ m|raw }}</span>
          </div>
        {% endfor %}
      {% endfor %}

      <div class="overflow-x-auto">
        <table class="table align-middle w-full">
          <colgroup>
            <col style="width:6rem">
            <col style="width:14rem">
            <col style="width:12rem">
            <col style="width:10rem">
            <col style="width:18rem">
          </colgroup>
          <thead class="whitespace-nowrap">
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Status</th>
              <th class="text-right">Total</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="whitespace-nowrap">
            {% for o in orders %}
              <tr>
                <td class="text-base-content/70">#{{ o.id }}</td>
                <td>{{ o.createdAt|date('Y-m-d H:i') }}</td>
                <td>
                  <span class="badge
                    {% if o.status in ['PAID','PAID_CONFIRMED','DELIVERED','COMPLETED','REFUNDED'] %}badge-success
                    {% elseif o.status in ['NEW','PREPARING','SHIPPING','PENDING'] %}badge-warning
                    {% elseif o.status in ['REFUND_REQUESTED','REFUND_PROCESSING'] %}badge-info
                    {% elseif o.status in ['CANCELED','REFUND_REJECTED'] %}badge-ghost
                    {% elseif o.status in ['FAILED','REFUND_FAILED'] %}badge-error
                    {% else %}badge-neutral{% endif %}">
                    {{ o.status|replace({'_': ' '})|capitalize }}
                  </span>
                </td>
                <td class="text-right font-medium">
                  {{ o.total|number_format(0,'.',',') }} ₫
                </td>

                <td class="text-right">
                  <div class="inline-flex items-center justify-end gap-2">
                    <a href="{{ path('app_orders_show', {id: o.id}) }}" class="btn btn-sm btn-outline">
                      View
                    </a>

                    {# MoMo: tiếp tục thanh toán khi chưa thanh toán xong #}
                    {% if o.paymentMethod == 'MOMO' and o.status in ['NEW','PENDING'] %}
                      <a href="{{ path('app_orders_resume', {id: o.id}) }}"
                         class="btn btn-sm btn-primary">
                        Continue payment
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-sm text-base-content/60 py-4">
                  You have no orders yet.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination #}
      {% set page = page|default(1) %}
      {% if pageCount is defined and pageCount > 1 %}
        <div class="mt-4 flex items-center justify-between text-sm text-base-content/80">
          <div>Page {{ page }} of {{ pageCount }}</div>
          <div class="join">
            {% set route = app.request.attributes.get('_route') %}
            {% set query = app.request.query.all %}
            <a class="btn btn-sm join-item {{ page <= 1 ? 'btn-disabled' : '' }}"
               href="{{ page <= 1 ? '#' : path(route, query|merge({'page': page - 1})) }}">
              « Prev
            </a>
            <a class="btn btn-sm join-item {{ page >= pageCount ? 'btn-disabled' : '' }}"
               href="{{ page >= pageCount ? '#' : path(route, query|merge({'page': page + 1})) }}">
              Next »
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
