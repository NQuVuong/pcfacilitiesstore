{# templates/detail.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ p.name }} — PC Store{% endblock %}

{% block body %}
<section class="bg-base-100">
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-6">
    <div class="breadcrumbs text-sm mb-4">
      <ul>
        <li><a href="{{ path('app_homepage') }}">Home</a></li>
        {% if p.category %}<li><a href="{{ path('catalog', {cat: p.category.id}) }}">{{ p.category.name }}</a></li>{% endif %}
        <li>{{ p.name }}</li>
      </ul>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-5">
        <div class="card bg-base-100 border">
          <figure class="bg-base-200 aspect-square">
            {% set main = p.image ? asset('uploads/' ~ p.image) : asset('uploads/placeholder.png') %}
            <img id="mainImage" src="{{ main }}" alt="{{ p.name }}" class="w-full h-full object-contain p-3">
          </figure>
        </div>

        <div class="mt-3 flex gap-2 overflow-x-auto">
          <button class="btn btn-ghost btn-sm px-0 border rounded w-20 h-20 shrink-0" data-main="{{ main }}">
            <img src="{{ main }}" class="object-contain w-full h-full p-1" alt="">
          </button>
          {% for gi in p.images|default([]) %}
            {% set url = asset('uploads/' ~ gi.path) %}
            <button class="btn btn-ghost btn-sm px-0 border rounded w-20 h-20 shrink-0" data-main="{{ url }}">
              <img src="{{ url }}" class="object-contain w-full h-full p-1" alt="">
            </button>
          {% endfor %}
        </div>
      </div>

      <div class="lg:col-span-7">
        <div class="card bg-base-100 border">
          <div class="card-body">
            <h1 class="text-2xl md:text-3xl font-semibold leading-tight">{{ p.name }}</h1>

            {% set latest = p.prices|first %}
            <div class="mt-2">
              {% if latest and latest.exportPrice is not null %}
                <div class="text-3xl font-bold text-primary">{{ latest.exportPrice|number_format(0,'.',',') }} ₫</div>
              {% else %}
                <div class="text-xl text-base-content/50 italic">No price</div>
              {% endif %}
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              <span class="badge badge-ghost">SKU: #{{ p.id }}</span>
              {% if p.category %}<span class="badge badge-ghost">{{ p.category.name }}</span>{% endif %}
              <span class="badge {{ p.quantity > 0 ? 'badge-success' : 'badge-error' }}">
                {{ p.quantity > 0 ? ('In stock: ' ~ p.quantity) : 'Out of stock' }}
              </span>
              <span class="badge badge-ghost">Added: {{ p.created ? p.created|date('d/m/Y') : '—' }}</span>
            </div>

            <div class="divider my-4"></div>

            <div class="flex items-center gap-3">
              <label class="form-control w-32">
                <div class="label"><span class="label-text">Quantity</span></div>
                <input id="qty" type="number" value="1" min="1" class="input input-bordered" />
              </label>

              {% if latest and latest.exportPrice is not null and p.quantity > 0 %}
                <form id="addToCartForm" action="{{ path('app_cart_add', {id: p.id}) }}" method="post" class="flex items-end">
                  <input type="hidden" name="_token" value="{{ csrf_token('add_to_cart_' ~ p.id) }}">
                  {# gửi qty thực sự về controller #}
                  <input type="hidden" name="qty" id="qtyField" value="1">
                  <button class="btn btn-primary">Add to cart</button>
                </form>
              {% else %}
                <button class="btn" disabled>Not available</button>
              {% endif %}
            </div>

            {# ĐÃ XOÁ nút Edit product để tránh staff/admin mở từ trang public #}
          </div>
        </div>
      </div>
    </div>

    {# Specs + Description #}
    <div class="mt-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-5">
        <div class="card bg-base-100 border">
          <div class="card-body">
            <h2 class="card-title">Specifications</h2>

            {% set specs = p.specs ?? [] %}
            {% if specs|length > 0 %}
              <div class="overflow-x-auto">
                <table class="table w-full">
                  <tbody>
                    {% for item in specs %}
                      {% set k = item.key|default('') %}
                      {% set v = item.value|default('') %}
                      {% if k is not empty or v is not empty %}
                        <tr>
                          <th class="w-48 align-top">{{ k }}</th>
                          <td>{{ v|nl2br }}</td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-base-content/70">No specifications.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="lg:col-span-7">
        <div class="card bg-base-100 border">
          <div class="card-body prose max-w-none">
            <h2 class="card-title">Product overview</h2>

            {% set hasDesc = p.description is not empty %}
            <div id="descWrap" class="{{ hasDesc ? 'max-h-64 overflow-hidden' : '' }}">
              {% if hasDesc %}
                {{ p.description|raw }}
              {% else %}
                <p class="text-base-content/70">No description yet.</p>
              {% endif %}
            </div>

            {% if hasDesc %}
              <button id="btnToggleDesc" class="btn btn-ghost btn-sm mt-2">Xem thêm</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function(){
    // thumbs -> main image
    const main = document.getElementById('mainImage');
    document.querySelectorAll('[data-main]').forEach(b=>{
      b.addEventListener('click', ()=>{ main.src = b.dataset.main; });
    });

    // sync qty to hidden field in form
    const qtyInput = document.getElementById('qty');
    const qtyField = document.getElementById('qtyField');
    if (qtyInput && qtyField) {
      const sync = () => { qtyField.value = Math.max(1, parseInt(qtyInput.value || '1', 10)); };
      qtyInput.addEventListener('input', sync);
      qtyInput.addEventListener('change', sync);
    }

    // Toggle description
    const wrap = document.getElementById('descWrap');
    const btn  = document.getElementById('btnToggleDesc');
    if (wrap && btn) {
      let open = false;
      btn.addEventListener('click', ()=>{
        open = !open;
        wrap.classList.toggle('max-h-64', !open);
        wrap.classList.toggle('overflow-hidden', !open);
        btn.textContent = open ? 'Thu gọn' : 'Xem thêm';
      });
    }
  })();
</script>
{% endblock %}
