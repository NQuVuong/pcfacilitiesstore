{# templates/home.html.twig (PC Store — Home) #}
{% extends 'base.html.twig' %}
{% block title %}PC Store — Home{% endblock %}

{% block body %}

{# ===== HERO: responsive carousel ===== #}
<section class="relative">
  <div class="carousel w-full overflow-x-scroll snap-x snap-mandatory scroll-smooth">
    <div id="slide1" class="carousel-item relative w-full h-[220px] sm:h-[320px] lg:h-[450px] snap-start flex-shrink-0">
      <img src="{{ asset('hero/mkeyboard.jpg') }}" class="w-full h-full object-cover" alt="Hero 1"/>
      <div class="absolute left-3 right-3 top-1/2 flex -translate-y-1/2 transform justify-between">
        <a href="#slide4" class="btn btn-circle btn-sm sm:btn-md">❮</a>
        <a href="#slide2" class="btn btn-circle btn-sm sm:btn-md">❯</a>
      </div>
    </div>

    <div id="slide2" class="carousel-item relative w-full h-[220px] sm:h-[320px] lg:h-[450px] snap-start flex-shrink-0">
      <img src="{{ asset('hero/LargeHero_Xbox_PeripheralsWrapper_Banner.jpg') }}" class="w-full h-full object-cover" alt="Hero 2"/>
      <div class="absolute left-3 right-3 top-1/2 flex -translate-y-1/2 transform justify-between">
        <a href="#slide1" class="btn btn-circle btn-sm sm:btn-md">❮</a>
        <a href="#slide3" class="btn btn-circle btn-sm sm:btn-md">❯</a>
      </div>
    </div>

    <div id="slide3" class="carousel-item relative w-full h-[220px] sm:h-[320px] lg:h-[450px] snap-start flex-shrink-0">
      <img src="{{ asset('hero/banner.jpg') }}" class="w-full h-full object-cover" alt="Hero 3"/>
      <div class="absolute left-3 right-3 top-1/2 flex -translate-y-1/2 transform justify-between">
        <a href="#slide2" class="btn btn-circle btn-sm sm:btn-md">❮</a>
        <a href="#slide4" class="btn btn-circle btn-sm sm:btn-md">❯</a>
      </div>
    </div>

    <div id="slide4" class="carousel-item relative w-full h-[220px] sm:h-[320px] lg:h-[450px] snap-start flex-shrink-0">
      <img src="{{ asset('hero/keyboard.jpg') }}" class="w-full h-full object-cover" alt="Hero 4"/>
      <div class="absolute left-3 right-3 top-1/2 flex -translate-y-1/2 transform justify-between">
        <a href="#slide3" class="btn btn-circle btn-sm sm:btn-md">❮</a>
        <a href="#slide1" class="btn btn-circle btn-sm sm:btn-md">❯</a>
      </div>
    </div>
  </div>
</section>

{# ===== Category rows (responsive grid) ===== #}
{% if categoriesWithProducts is defined and categoriesWithProducts|length > 0 %}
  {% for row in categoriesWithProducts %}
    {% set catEntity = row.category %}
    {% set items = row.products %}
    {% if items|length > 0 %}
      <section class="bg-base-100">
        <div class="max-w-7xl mx-auto px-4 lg:px-8 py-6 lg:py-8">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-base md:text-lg font-semibold">{{ catEntity.name }}</h2>
            <a class="btn btn-ghost btn-xs md:btn-sm" href="{{ path('catalog', { cat: catEntity.id }) }}">View all</a>
          </div>

          {# Mobile: 2 cột, Tablet: 3, Desktop: 4 #}
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for p in items|slice(0, 4) %}
              {% include '_components/product-card.html.twig' with { p: p, specs_count: 3 } %}
            {% endfor %}
          </div>
        </div>
      </section>
    {% endif %}
  {% endfor %}
{% endif %}

{# ==== Recently viewed ==== #}
{% if recentProducts is defined %}
<section class="bg-base-100 mt-8">
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Recently viewed</h2>

      {# View more -> sang Profile (ở đó sau này show full danh sách đã xem) #}
      <a href="{{ path('account_profile') }}"
         class="text-sm font-medium text-primary hover:underline">
        View more
      </a>
    </div>

    {% if recentProducts is empty %}
      <p class="text-sm text-base-content/60 italic">
        You haven’t viewed any products yet.
      </p>
    {% else %}
      {# GRID, TỰ XUỐNG HÀNG -> KHÔNG BỊ TRÀN #}
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        {% for p in recentProducts %}
          {% include '_components/product-card.html.twig' with { p: p, specs_count: 3 } %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
</section>
{% endif %}

{% endblock %}

{# === JS riêng của trang home: đặt ở cuối body đúng block === #}
{% block javascripts_bottom %}
  {{ parent() }}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const carousel = document.querySelector('.carousel');
      if (!carousel) return;

      const items = carousel.querySelectorAll('.carousel-item');
      const itemCount = items.length;
      if (itemCount <= 1) return;

      let currentSlideIndex = 0;
      let autoPlayInterval = null;

      const scrollToSlide = (index) => {
        currentSlideIndex = (index + itemCount) % itemCount;
        const targetSlide = items[currentSlideIndex];
        if (!targetSlide) return;
        // chỉ scroll HORIZONTAL bên trong carousel, không scroll cả trang
        const offsetLeft = targetSlide.offsetLeft;
        carousel.scrollTo({ left: offsetLeft, behavior: 'smooth' });
      };

      const goToNextSlide = () => scrollToSlide(currentSlideIndex + 1);

      const startAutoplay = () => {
        if (autoPlayInterval === null) {
          autoPlayInterval = setInterval(goToNextSlide, 4000);
        }
      };
      const stopAutoplay = () => {
        if (autoPlayInterval !== null) {
          clearInterval(autoPlayInterval);
          autoPlayInterval = null;
        }
      };

      // Nút điều hướng (❮ ❯)
      carousel.querySelectorAll('.carousel-item a.btn-circle').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const href = btn.getAttribute('href');
          const target = href ? document.getElementById(href.substring(1)) : null;
          const idx = target ? Array.from(items).indexOf(target) : -1;
          if (idx !== -1) {
            stopAutoplay();
            scrollToSlide(idx);
            startAutoplay();
          }
        });
      });

      // Chỉ chạy autoplay khi hero đang trong viewport
      const observer = new IntersectionObserver((entries) => {
        const entry = entries[0];
        if (entry.isIntersecting) startAutoplay();
        else stopAutoplay();
      }, { threshold: 0.4 });

      observer.observe(carousel);

      // Hover pause
      carousel.addEventListener('mouseenter', stopAutoplay);
      carousel.addEventListener('mouseleave', startAutoplay);
    });
  </script>
{% endblock %}
