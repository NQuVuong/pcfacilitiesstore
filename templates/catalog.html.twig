{# templates/catalog.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Catalog — PC Store{% endblock %}

{% block body %}
<section class="bg-base-100">
  <div class="max-w-6xl mx-auto px-4 lg:px-8 py-8 space-y-6">

    {# Header + tổng số sản phẩm #}
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Catalog</h1>
        <p class="text-sm text-base-content/70">
          Browse all products in the store.
        </p>
      </div>
      <div class="text-sm text-base-content/70">
        {{ total }} product{{ total == 1 ? '' : 's' }}
      </div>
    </div>

    {# Bộ lọc #}
    <form method="get" action="{{ path('catalog') }}"
          class="bg-base-100 border rounded-2xl shadow-sm p-4 md:p-5 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4 items-end">

        {# search #}
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold uppercase tracking-wide mb-1">
            Search products
          </label>
          <input
            type="text"
            name="q"
            value="{{ q }}"
            placeholder="Search by name, keyword..."
            class="input input-bordered w-full"
          >
        </div>

        {# category #}
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wide mb-1">
            All categories
          </label>
          <select name="cat" class="select select-bordered w-full">
            <option value="">All categories</option>
            {% for c in categories %}
              <option value="{{ c.id }}" {{ cat is not null and cat == c.id ? 'selected' : '' }}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        {# brand #}
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wide mb-1">
            All brands
          </label>
          <select name="brand" class="select select-bordered w-full">
            <option value="">All brands</option>
            {% for b in brands %}
              <option value="{{ b.id }}" {{ brand is not null and brand == b.id ? 'selected' : '' }}>
                {{ b.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-base-200 mt-3">
        <div class="flex items-center gap-2 text-sm">
          <span class="text-base-content/70">Sort by</span>
          <select name="sort" class="select select-bordered select-sm">
            <option value="newest"  {{ sort == 'newest'  ? 'selected' : '' }}>Newest</option>
            <option value="price_asc"  {{ sort == 'price_asc'  ? 'selected' : '' }}>Price: Low → High</option>
            <option value="price_desc" {{ sort == 'price_desc' ? 'selected' : '' }}>Price: High → Low</option>
            <option value="rating" {{ sort == 'rating' ? 'selected' : '' }}>Rating</option>
          </select>
        </div>

        <div class="flex items-center gap-2">
          <button type="submit" class="btn btn-primary btn-sm px-5">
            Apply
          </button>
          <a href="{{ path('catalog') }}" class="btn btn-ghost btn-sm">
            Clear
          </a>
        </div>
      </div>
    </form>

    {# Product grid #}
    {% if products is not empty %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        {% for p in products %}
          <a href="{{ path('product_detail', { slug: p.slug }) }}"
             class="card bg-base-100 shadow-sm hover:shadow-md transition rounded-2xl border border-base-200">
            <figure class="px-4 pt-4 pb-2">
              <img
                src="{{ p.image ? asset('uploads/' ~ p.image) : asset('img/placeholder.png') }}"
                alt="{{ p.name }}"
                class="w-full h-44 object-contain"
                loading="lazy"
              >
            </figure>
            <div class="card-body p-4 space-y-2">
              <h2 class="card-title text-base leading-snug line-clamp-2">
                {{ p.name }}
              </h2>

              {# rating (nếu có) #}
              {% if p.averageRating is not null %}
                <div class="flex items-center gap-1 text-xs text-amber-500">
                  ★ {{ p.averageRating|number_format(1, '.', '') }}/5
                </div>
              {% endif %}

              <div class="flex items-center justify-between mt-1">
                <div class="text-primary font-semibold text-lg">
                  {% set price = p.currentExportPrice ?? 0 %}
                  {{ price|number_format(0, '.', ',') }} ₫
                </div>
                <div class="text-xs text-base-content/60">
                  In stock: {{ p.quantity }}
                </div>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="border border-dashed rounded-2xl p-8 text-center text-base-content/60">
        No products found. Try changing filters or search keyword.
      </div>
    {% endif %}

    {# Pagination dưới cùng #}
    {% if pageCount > 1 %}
      {% set route = app.request.attributes.get('_route') %}
      {% set query = app.request.query.all %}

      <div class="mt-6 flex justify-center">
        <div class="join">
          {# Prev #}
          <a class="join-item btn btn-sm {{ page <= 1 ? 'btn-disabled' }}"
             href="{{ page <= 1 ? '#' : path(route, query|merge({'page': page - 1})) }}">
            « Prev
          </a>

          <span class="join-item btn btn-sm btn-ghost no-pointer-events">
            Page {{ page }} / {{ pageCount }}
          </span>

          {# Next #}
          <a class="join-item btn btn-sm {{ page >= pageCount ? 'btn-disabled' }}"
             href="{{ page >= pageCount ? '#' : path(route, query|merge({'page': page + 1})) }}">
            Next »
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
