{# templates/admin_order/show.html.twig #}
{% extends 'admin.html.twig' %}
{% block title %}Order #{{ order.id }} (Admin){% endblock %}

{% block body %}
<div class="max-w-5xl mx-auto p-4 space-y-4">

  {% for label, messages in app.flashes(['admin.success', 'admin.error', 'admin.info']) %}
    {% for m in messages %}
      <div class="alert {{ label matches '/error/' ? 'alert-error' : (label matches '/success/' ? 'alert-success' : 'alert-info') }} mb-3 shadow-lg">
        <span>{{ m }}</span>
      </div>
    {% endfor %}
  {% endfor %}

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h1 class="card-title">Order #{{ order.id }}</h1>
      <p><strong>User:</strong> {{ order.user ? order.user.email : (order.customerEmail ?: 'Guest') }}</p>
      <p><strong>Status:</strong>
        <span class="badge">{{ order.status|replace({'_': ' '})|capitalize }}</span>
      </p>
      <p><strong>Total:</strong> {{ order.total|number_format(0,'.',',') }} ₫</p>
      <p><strong>Payment Method:</strong> {{ order.paymentMethod|default('N/A') }}</p>
      <p><strong>MoMo Order ID:</strong> {{ order.momoOrderId|default('N/A') }}</p>
      <p><strong>MoMo Transaction ID:</strong> {{ order.paymentTxnId|default('N/A') }}</p>
      <p><strong>Refundable Remaining:</strong> {{ order.refundableRemaining|default(0)|number_format(0,'.',',') }} ₫</p>
      <p><strong>Refunded Total:</strong> {{ order.refundedTotal|default(0)|number_format(0,'.',',') }} ₫</p>
    </div>
  </div>

  {# ====== ADMIN: UPDATE STATUS (NEW/PAID -> PREPARING -> SHIPPING -> DELIVERED) ====== #}
  {% set next = null %}
  {% if order.status in ['NEW','PAID'] %}
    {% set next = 'PREPARING' %}
  {% elseif order.status == 'PREPARING' %}
    {% set next = 'SHIPPING' %}
  {% elseif order.status == 'SHIPPING' %}
    {% set next = 'DELIVERED' %}
  {% endif %}

  {% if next is not null %}
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">Update status</h2>
        <p class="text-sm text-base-content/70 mb-2">
          Current: <b>{{ order.status|replace({'_':' '})|capitalize }}</b> →
          Next: <b>{{ next|replace({'_':' '})|capitalize }}</b>
        </p>

        <button type="button"
                class="btn btn-primary btn-sm"
                onclick="document.getElementById('update-status-modal').showModal()">
          Set to {{ next|replace({'_':' '})|capitalize }}
        </button>

        <dialog id="update-status-modal" class="modal">
          <div class="modal-box">
            <h3 class="font-bold text-lg mb-2">Confirm status change</h3>
            <p>Update order #{{ order.id }} status to <b>{{ next|replace({'_':' '})|capitalize }}</b>?</p>
            <div class="modal-action">
              <form method="POST"
                    action="{{ path('app_admin_order_update_status', {id: order.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('update_status_' ~ order.id) }}">
                <input type="hidden" name="next_status" value="{{ next }}">
                <button type="submit" class="btn btn-primary">OK</button>
              </form>
              <form method="dialog">
                <button class="btn">Cancel</button>
              </form>
            </div>
          </div>
          <form method="dialog" class="modal-backdrop">
            <button>close</button>
          </form>
        </dialog>
      </div>
    </div>
  {% endif %}

  {# ====== ITEMS ====== #}
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title">Items</h2>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items %}
              <tr>
                <td>{{ item.productName }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.unitPrice|number_format(0,'.',',') }} ₫</td>
                <td>{{ item.lineTotal|number_format(0,'.',',') }} ₫</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <a href="{{ path('app_admin_order_index') }}" class="btn btn-ghost">← Back to Order List</a>
</div>
{% endblock %}
