{% extends 'admin.html.twig' %}
{% block title %}Order #{{ order.id }} (Admin){% endblock %}

{% block body %}
<div class="max-w-5xl mx-auto p-4 space-y-4">

  {% for label, messages in app.flashes(['admin.success', 'admin.error', 'admin.info']) %}
    {% for m in messages %}
      <div class="alert {{ label matches '/error/' ? 'alert-error' : (label matches '/success/' ? 'alert-success' : 'alert-info') }} mb-3 shadow-lg">
        <span>{{ m }}</span>
      </div>
    {% endfor %}
  {% endfor %}

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h1 class="card-title">Order #{{ order.id }}</h1>
      <p><strong>User:</strong> {{ order.user.email }}</p>
      <p><strong>Status:</strong> <span class="badge">{{ order.status|replace({'_': ' '})|capitalize }}</span></p>
      <p><strong>Total:</strong> {{ order.total|number_format(0,'.',',') }} ₫</p>
      <p><strong>Payment Method:</strong> {{ order.paymentMethod|default('N/A') }}</p>
      <p><strong>MoMo Order ID:</strong> {{ order.momoOrderId|default('N/A') }}</p>
      <p><strong>MoMo Transaction ID:</strong> {{ order.paymentTxnId|default('N/A') }}</p>
      <p><strong>Refundable Remaining:</strong> {{ order.refundableRemaining|default(0)|number_format(0,'.',',') }} ₫</p>
      <p><strong>Refunded Total:</strong> {{ order.refundedTotal|default(0)|number_format(0,'.',',') }} ₫</p>
    </div>
  </div>

  {% if order.paymentMethod == 'MOMO' and order.status == 'REFUND_REQUESTED' %}
    <div class="card bg-base-100 shadow border-error border">
      <div class="card-body">
        <h2 class="card-title text-error">Xác nhận Hoàn tiền (Refund)</h2>
        <p>Hoàn lại <strong>{{ order.refundableRemaining|default(0)|number_format(0,'.',',') }} ₫</strong>.</p>
        <form method="POST" action="{{ path('app_admin_order_refund', {id: order.id}) }}" onsubmit="return confirm('Hoàn tiền cho đơn #{{ order.id }}?');">
          <input type="hidden" name="_token" value="{{ csrf_token('refund-order-' ~ order.id) }}">
          <button type="submit" class="btn btn-error">Duyệt & Gửi MoMo</button>
        </form>
      </div>
    </div>
  {% endif %}

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title">Items</h2>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items %}
            <tr>
              <td>{{ item.productName }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.unitPrice|number_format(0,'.',',') }} ₫</td>
              <td>{{ item.lineTotal|number_format(0,'.',',') }} ₫</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <a href="{{ path('app_admin_order_index') }}" class="btn btn-ghost">← Back to Order List</a>
</div>
{% endblock %}
