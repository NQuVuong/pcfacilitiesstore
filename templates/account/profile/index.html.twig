{% extends 'base.html.twig' %}
{% block title %}My profile{% endblock %}

{% block body %}
<div class="max-w-6xl mx-auto my-10 grid grid-cols-1 md:grid-cols-3 gap-6">

  {# Sidebar #}
  <aside class="bg-base-100 rounded-xl border border-base-200 p-5">
    <div class="flex items-center gap-3">
      {% set rawAvatar = user.avatar ?? '' %}
      {% set fallback  = (user.gender ?? '') == 'female' ? 'women.png' : 'man.png' %}
      {% set finalName = rawAvatar is not empty ? rawAvatar : fallback %}
      {% set avatarUrl = (finalName starts with 'http' or finalName starts with '//')
          ? finalName : asset('uploads/avatars/' ~ finalName) %}

      <img src="{{ avatarUrl }}" class="w-16 h-16 rounded-full border" alt="avatar">
      <div>
        <div class="font-semibold text-sm text-base-content">
          {{ user.fullName ?? user.email }}
        </div>
        <div class="text-xs text-base-content/60 break-words">
          {{ user.email }}
        </div>
      </div>
    </div>

    <ul class="menu mt-6 text-sm rounded-lg bg-base-100">
      <li>
        <a class="active">
          <span>Profile</span>
        </a>
      </li>
      <li>
        <a href="{{ path('app_orders_index') }}">
          <span>My orders</span>
        </a>
      </li>
      <li>
        <a href="{{ path('account_change_password') }}">
          <span>Change password</span>
        </a>
      </li>
      <li>
        <a href="#recently-viewed">
          <span>Recently viewed</span>
        </a>
      </li>
      <li class="mt-3">
        <form method="post" action="{{ path('app_logout') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
          <button class="btn btn-error btn-sm w-full" type="submit">Logout</button>
        </form>
      </li>
    </ul>
  </aside>

  {# Content #}
  <section class="md:col-span-2 space-y-8">

    {# AVATAR FORM #}
    <div class="bg-base-100 rounded-xl shadow-sm border border-base-200 p-6">
      <h2 class="text-lg font-semibold mb-3">Avatar</h2>
      <div class="flex flex-wrap items-center gap-4">
        <img src="{{ avatarUrl }}" alt="avatar" class="w-16 h-16 rounded-full border">

        {{ form_start(avatar_form, { attr: { enctype: 'multipart/form-data', class: 'flex items-center gap-3 flex-1' } }) }}
          {{ form_widget(avatar_form.avatarFile, {
            attr: { class: 'file-input file-input-bordered w-full max-w-xs' }
          }) }}
          <button class="btn btn-primary btn-sm" type="submit">Update avatar</button>
        {{ form_end(avatar_form) }}
      </div>
    </div>

    {# PROFILE FORM #}
    <div class="bg-base-100 rounded-xl shadow-sm border border-base-200 p-6">
      <h2 class="text-lg font-semibold mb-4">Account information</h2>

      {{ form_start(profile_form) }}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        <div>
          <label class="block mb-2 text-sm font-medium text-base-content">
            {{ profile_form.fullName.vars.label }}
          </label>
          {{ form_widget(profile_form.fullName) }}
          <div class="text-xs text-error mt-1">{{ form_errors(profile_form.fullName) }}</div>
        </div>

        <div>
          <label class="block mb-2 text-sm font-medium text-base-content">
            {{ profile_form.birthday.vars.label }}
          </label>
          {{ form_widget(profile_form.birthday) }}
          <div class="text-xs text-error mt-1">{{ form_errors(profile_form.birthday) }}</div>
        </div>

        {% if profile_form.gender is defined %}
          <div class="md:col-span-2">
            <span class="block mb-2 text-sm font-medium text-base-content">Gender</span>
            <div class="flex items-center gap-4">
              {{ form_widget(profile_form.gender) }}
            </div>
            <div class="text-xs text-error mt-1">{{ form_errors(profile_form.gender) }}</div>
          </div>
        {% endif %}

        <div>
          <label class="block mb-2 text-sm font-medium text-base-content">
            {{ profile_form.phone.vars.label }}
          </label>
          {{ form_widget(profile_form.phone) }}
          <div class="text-xs text-error mt-1">{{ form_errors(profile_form.phone) }}</div>
        </div>

        <div>
          <label class="block mb-2 text-sm font-medium text-base-content">
            {{ profile_form.email.vars.label }}
          </label>
          {{ form_widget(profile_form.email) }}
        </div>

        <div class="md:col-span-2 flex justify-end">
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>

      </div>
      {{ form_end(profile_form) }}
    </div>

    {# RECENTLY VIEWED #}
    {% if recentProducts is not empty %}
      <section id="recently-viewed" class="bg-base-100 rounded-xl shadow-sm border border-base-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Recently viewed products</h2>
          <a href="{{ path('catalog') }}" class="link text-sm">Browse catalog</a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for p in recentProducts %}
            {% include '_components/product-card.html.twig' with { p: p, specs_count: 2 } %}
          {% endfor %}
        </div>
      </section>
    {% endif %}

  </section>
</div>
{% endblock %}
